<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahtzee Elite - Physics Edition</title>
    <style>
        :root {
            --bg: #f4f7f9;
            --surface: #ffffff;
            --text: #2c3e50;
            --primary: #007bff;
            --border: #d1d8e0;
            --shaded: #f8f9fa;
            --tray-bg: #3c8dab; /* Octagon Tray Color */
            /* Player Backgrounds */
            --c1: #e3f2fd; --c2: #fff9db; --c3: #f3e5f5; --c4: #e8f5e9;
            --c5: #fff3e0; --c6: #fce4ec; --c7: #f1f2f6; --c8: #ffffff;
        }

        [data-theme="dark"] {
            --bg: #1a1a1a; --surface: #2d2d2d; --text: #ecf0f1;
            --border: #444; --shaded: #333; --tray-bg: #1e3a45;
        }

        * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; transition: 0.3s; }

        /* --- Header Controls --- */
        .nav { display: flex; justify-content: space-between; max-width: 1200px; margin: 0 auto 15px; flex-wrap: wrap; gap: 10px; }
        .btn {
            padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--surface); color: var(--text); font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn:hover { background: var(--shaded); border-color: var(--primary); }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px 40px; font-size: 1.1rem; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* --- 3D Physics Octagon Tray --- */
        .tray-wrapper {
            width: 100%; max-width: 700px; height: 350px; margin: 0 auto 20px;
            perspective: 1000px; position: relative;
        }
        .tray {
            width: 100%; height: 100%; background: var(--tray-bg);
            clip-path: polygon(30% 0%, 70% 0%, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0% 70%, 0% 30%);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
            border: 4px solid rgba(255,255,255,0.1);
        }

        .die {
            position: absolute; width: 45px; height: 45px; transform-style: preserve-3d;
            transition: top 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67),
                        left 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67),
                        transform 0.6s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        .face {
            position: absolute; width: 45px; height: 45px; background: white;
            border: 1px solid #ddd; border-radius: 6px; display: flex;
            align-items: center; justify-content: center; font-size: 18px;
            font-weight: bold; color: #333; box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        .f1 { transform: rotateY(0deg) translateZ(22.5px); }
        .f2 { transform: rotateY(180deg) translateZ(22.5px); }
        .f3 { transform: rotateY(90deg) translateZ(22.5px); }
        .f4 { transform: rotateY(-90deg) translateZ(22.5px); }
        .f5 { transform: rotateX(90deg) translateZ(22.5px); }
        .f6 { transform: rotateX(-90deg) translateZ(22.5px); }

        /* --- Lock Rack --- */
        .rack { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .slot {
            width: 55px; height: 70px; background: var(--surface); border: 2px solid var(--border);
            border-radius: 8px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .slot.held { border-color: var(--primary); background: #eef7ff; transform: translateY(-4px); }
        .slot b { font-size: 20px; }
        .slot small { font-size: 8px; font-weight: bold; color: var(--primary); opacity: 0; }
        .slot.held small { opacity: 1; }

        /* --- Scorecard Table --- */
        .table-wrap { width: 100%; overflow-x: auto; display: flex; justify-content: center; }
        table { border-collapse: collapse; background: var(--surface); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        th, td { border: 1px solid var(--border); padding: 10px; text-align: center; min-width: 140px; }
        .col-cat { width: 180px; text-align: left; font-weight: bold; position: sticky; left: 0; background: var(--surface); z-index: 10; }

        .row-shaded { background: var(--shaded) !important; font-weight: 800; }
        .score-input { width: 100%; border: none; background: transparent; text-align: center; font-size: 16px; font-weight: bold; color: var(--primary); outline: none; cursor: pointer; }

        /* --- Clickable Radial Menu --- */
        .radial-container { position: relative; display: inline-block; margin-top: 5px; }
        .radial-menu {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 110px; height: 110px; border-radius: 50%; background: transparent;
            visibility: hidden; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100;
        }
        .radial-menu.active { visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .dot {
            position: absolute; width: 26px; height: 26px; border-radius: 50%; border: 2px solid white;
            cursor: pointer; transform: translate(-50%, -50%); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- Tooltips --- */
        .info { cursor: help; color: var(--primary); margin-left: 5px; position: relative; display: inline-block; }
        .tip {
            position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
            width: 140px; background: #333; color: #fff; padding: 8px; border-radius: 6px;
            font-size: 11px; display: none; z-index: 200; pointer-events: none;
        }
        .info:hover .tip { display: block; }

        /* --- Drag and Drop --- */
        .draggable { cursor: move; user-select: none; }
        .dragging { opacity: 0.5; background: var(--shaded); }
    </style>
</head>
<body data-theme="light">

    <div class="nav">
        <div>
            <button class="btn" onclick="game.addPlayer()">üë§ Add Player</button>
            <button class="btn" onclick="game.toggleMode()" id="modeBtn">üìù Scorecard Only</button>
        </div>
        <div>
            <button class="btn" onclick="game.toggleTheme()">üåì Theme</button>
            <button class="btn" onclick="game.resetDice()">üé≤ Clear Dice</button>
            <button class="btn" style="color:#e74c3c" onclick="game.fullReset()">Full Reset</button>
        </div>
    </div>

    <div class="tray-wrapper">
        <div class="tray" id="tray"></div>
    </div>

    <div class="rack">
        <div class="slot" onclick="game.toggleHold(0)" id="slot-0"><small>LOCKED</small><b id="v-0">-</b></div>
        <div class="slot" onclick="game.toggleHold(1)" id="slot-1"><small>LOCKED</small><b id="v-1">-</b></div>
        <div class="slot" onclick="game.toggleHold(2)" id="slot-2"><small>LOCKED</small><b id="v-2">-</b></div>
        <div class="slot" onclick="game.toggleHold(3)" id="slot-3"><small>LOCKED</small><b id="v-3">-</b></div>
        <div class="slot" onclick="game.toggleHold(4)" id="slot-4"><small>LOCKED</small><b id="v-4">-</b></div>
    </div>

    <div style="text-align:center; margin-bottom:30px;">
        <button class="btn btn-primary" id="rollBtn" onclick="game.roll()">ROLL DICE</button>
        <p id="rollCounter" style="font-weight:bold; margin-top:8px;">ROLL 0 / 3</p>
    </div>

    <div class="table-wrap">
        <table id="scoreTable">
            <thead id="head"></thead>
            <tbody id="rows"></tbody>
        </table>
    </div>

    <script>
        const COLORS = ['--c1', '--c2', '--c3', '--c4', '--c5', '--c6', '--c7', '--c8'];
        const RULES = [
            { id: '1s', name: 'Ones', tip: 'Total of 1s' },
            { id: '2s', name: 'Twos', tip: 'Total of 2s' },
            { id: '3s', name: 'Threes', tip: 'Total of 3s' },
            { id: '4s', name: 'Fours', tip: 'Total of 4s' },
            { id: '5s', name: 'Fives', tip: 'Total of 5s' },
            { id: '6s', name: 'Sixes', tip: 'Total of 6s' },
            { id: 'uSum', name: 'Upper Total', tip: 'Sum of 1-6', shaded: true, calc: true },
            { id: 'bonus', name: 'Bonus', tip: '35 pts if Total ‚â• 63', shaded: true, calc: true },
            { id: 'tk', name: '3 of a Kind', tip: 'Sum of all dice' },
            { id: 'fk', name: '4 of a Kind', tip: 'Sum of all dice' },
            { id: 'fh', name: 'Full House', tip: '25 pts' },
            { id: 'ss', name: 'Small Straight', tip: '30 pts' },
            { id: 'ls', name: 'Large Straight', tip: '40 pts' },
            { id: 'yz', name: 'Yahtzee', tip: '50 pts' },
            { id: 'ch', name: 'Chance', tip: 'Sum of all' },
            { id: 'grand', name: 'GRAND TOTAL', tip: 'Final Score', shaded: true, calc: true }
        ];

        const ROT = { 1:'rotateX(0deg)', 2:'rotateY(180deg)', 3:'rotateY(-90deg)', 4:'rotateY(90deg)', 5:'rotateX(-90deg)', 6:'rotateX(90deg)' };

        class YahtzeeElite {
            constructor() {
                this.players = [{ name: 'Player 1', color: '--c1', scores: {} }];
                this.dice = [0,0,0,0,0];
                this.held = [false,false,false,false,false];
                this.rolls = 0;
                this.isScorecardOnly = false;
                this.isRolling = false;
                this.init();
            }

            init() { this.renderAll(); }

            // --- Physics Roll ---
            roll() {
                if (this.rolls >= 3 || this.isRolling) return;
                this.isRolling = true;
                this.rolls++;

                const tray = document.getElementById('tray');
                // Persistence: Only clear tray dice that aren't held
                const activeDice = tray.querySelectorAll('.die');
                activeDice.forEach(d => { if(!this.held[d.dataset.idx]) d.remove(); });

                this.dice = this.dice.map((v, i) => this.held[i] ? v : Math.floor(Math.random() * 6) + 1);

                this.dice.forEach((val, i) => {
                    if (this.held[i]) return;
                    const die = document.createElement('div');
                    die.className = 'die';
                    die.dataset.idx = i;
                    die.style.left = '50%'; die.style.top = '-50px';
                    die.innerHTML = `<div class="cube" id="cube-${i}">
                        ${[1,2,3,4,5,6].map(n => `<div class="face f${n}">${n}</div>`).join('')}
                    </div>`;
                    tray.appendChild(die);

                    // Physics Tumble
                    setTimeout(() => {
                        die.style.left = `${10 + Math.random() * 80}%`;
                        die.style.top = `${15 + Math.random() * 70}%`;
                        const cube = document.getElementById(`cube-${i}`);
                        cube.style.transform = `${ROT[val]} rotateZ(${Math.random() * 360}deg)`;
                    }, i * 60);
                });

                setTimeout(() => {
                    this.isRolling = false;
                    this.updateRack();
                    document.getElementById('rollCounter').innerText = `ROLL ${this.rolls} / 3`;
                    if(this.rolls === 3) document.getElementById('rollBtn').disabled = true;
                }, 800);
            }

            updateRack() { this.dice.forEach((v, i) => { document.getElementById(`v-${i}`).innerText = v || '-'; }); }

            toggleHold(i) {
                if (this.rolls === 0 || this.isRolling) return;
                this.held[i] = !this.held[i];
                document.getElementById(`slot-${i}`).classList.toggle('held', this.held[i]);
            }

            // --- Drag and Drop ---
            setupDragEvents() {
                const headers = document.querySelectorAll('.col-player');
                headers.forEach(header => {
                    header.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', header.dataset.idx);
                        header.classList.add('dragging');
                    });
                    header.addEventListener('dragover', (e) => e.preventDefault());
                    header.addEventListener('drop', (e) => {
                        const fromIdx = e.dataTransfer.getData('text/plain');
                        const toIdx = header.dataset.idx;
                        this.movePlayer(parseInt(fromIdx), parseInt(toIdx));
                    });
                    header.addEventListener('dragend', () => header.classList.remove('dragging'));
                });
            }

            movePlayer(from, to) {
                const player = this.players.splice(from, 1)[0];
                this.players.splice(to, 0, player);
                this.renderAll();
            }

            // --- UI Rendering ---
            renderAll() {
                this.renderHeaders();
                this.renderRows();
                this.setupDragEvents();
            }

            renderHeaders() {
                const head = document.getElementById('head');
                let html = `<tr><th class="col-cat"></th>`;
                this.players.forEach((p, i) => {
                    html += `
                        <th class="col-player draggable" draggable="true" data-idx="${i}" style="background: var(${p.color})">
                            <input value="${p.name}" onchange="game.players[${i}].name=this.value"
                                style="border:none; background:transparent; font-weight:bold; text-align:center; width:100px;">
                            <div class="radial-container">
                                <div onclick="game.toggleRadial(${i})" style="width:20px; height:20px; border-radius:50%; background:var(${p.color}); border:2px solid #fff; cursor:pointer; margin:5px auto;"></div>
                                <div class="radial-menu" id="radial-${i}">
                                    ${COLORS.map((c, ci) => `
                                        <div class="dot" style="background:var(${c});
                                             left:${50 + 40 * Math.cos(ci * 0.78)}%;
                                             top:${50 + 40 * Math.sin(ci * 0.78)}%;"
                                             onclick="game.setPlayerColor(${i}, '${c}')"></div>
                                    `).join('')}
                                </div>
                            </div>
                            <div onclick="game.removePlayer(${i})" style="font-size:10px; cursor:pointer; opacity:0.6;">Remove</div>
                        </th>`;
                });
                head.innerHTML = html + `</tr>`;
            }

            renderRows() {
                const tbody = document.getElementById('rows');
                tbody.innerHTML = '';
                RULES.forEach(rule => {
                    const tr = document.createElement('tr');
                    if (rule.shaded) tr.classList.add('row-shaded');
                    let html = `<td class="col-cat">
                        ${rule.name} <span class="info">‚ìò<div class="tip">${rule.tip}</div></span>
                    </td>`;
                    this.players.forEach((p, pIdx) => {
                        const score = p.scores[rule.id];
                        if (rule.calc) {
                            html += `<td style="background: var(${p.color})">${this.calculate(pIdx, rule.id)}</td>`;
                        } else {
                            html += `
                                <td style="background: var(${p.color})">
                                    <input class="score-input" type="number" value="${score ?? ''}"
                                        ${this.isScorecardOnly ? '' : 'readonly'}
                                        onclick="${this.isScorecardOnly ? '' : `game.scoreMove(${pIdx}, '${rule.id}')`}"
                                        onchange="game.manualEntry(${pIdx}, '${rule.id}', this.value)">
                                </td>`;
                        }
                    });
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });
            }

            // --- Mechanics ---
            toggleRadial(i) {
                const menu = document.getElementById(`radial-${i}`);
                const isActive = menu.classList.contains('active');
                document.querySelectorAll('.radial-menu').forEach(m => m.classList.remove('active'));
                if(!isActive) menu.classList.add('active');
            }

            setPlayerColor(i, c) { this.players[i].color = c; this.renderAll(); }

            scoreMove(pIdx, id) {
                if (this.rolls === 0 || this.players[pIdx].scores[id] !== undefined) return;
                this.players[pIdx].scores[id] = this.calcLogic(id);
                this.resetDice();
                this.renderAll();
            }

            manualEntry(pIdx, id, val) {
                let n = parseInt(val);
                if (isNaN(n)) delete this.players[pIdx].scores[id];
                else this.players[pIdx].scores[id] = n;
                this.renderRows();
            }

            resetDice() {
                this.rolls = 0; this.held = [false,false,false,false,false]; this.dice = [0,0,0,0,0];
                document.getElementById('rollBtn').disabled = false;
                document.getElementById('rollCounter').innerText = `ROLL 0 / 3`;
                document.getElementById('tray').innerHTML = '';
                document.querySelectorAll('.slot').forEach(s => s.classList.remove('held'));
                this.updateRack();
            }

            fullReset() { if(confirm("Reset entire game?")) { this.players.forEach(p => p.scores = {}); this.resetDice(); this.renderAll(); }}

            calcLogic(id) {
                const d = this.dice;
                const sum = d.reduce((a,b)=>a+b, 0);
                const counts = d.reduce((acc, v) => { acc[v] = (acc[v] || 0) + 1; return acc; }, {});
                const u = [...new Set(d)].sort();
                switch(id) {
                    case '1s': return d.filter(x=>x===1).length;
                    case '2s': return d.filter(x=>x===2).length * 2;
                    case '3s': return d.filter(x=>x===3).length * 3;
                    case '4s': return d.filter(x=>x===4).length * 4;
                    case '5s': return d.filter(x=>x===5).length * 5;
                    case '6s': return d.filter(x=>x===6).length * 6;
                    case 'tk': return Object.values(counts).some(x=>x>=3) ? sum : 0;
                    case 'fk': return Object.values(counts).some(x=>x>=4) ? sum : 0;
                    case 'fh': return Object.values(counts).includes(3) && Object.values(counts).includes(2) ? 25 : 0;
                    case 'ss': return /1234|2345|3456/.test(u.join('')) ? 30 : 0;
                    case 'ls': return /12345|23456/.test(u.join('')) ? 40 : 0;
                    case 'yz': return Object.values(counts).includes(5) ? 50 : 0;
                    case 'ch': return sum;
                    default: return 0;
                }
            }

            calculate(pIdx, type) {
                const p = this.players[pIdx];
                const uIds = ['1s','2s','3s','4s','5s','6s'];
                const uSum = uIds.reduce((s, id) => s + (p.scores[id] || 0), 0);
                if(type === 'uSum') return uSum;
                if(type === 'bonus') return uSum >= 63 ? 35 : 0;
                if(type === 'grand') {
                    const lSum = RULES.filter(r => !r.calc && !uIds.includes(r.id)).reduce((s, r) => s + (p.scores[r.id] || 0), 0);
                    return uSum + lSum + (uSum >= 63 ? 35 : 0);
                }
            }

            addPlayer() { this.players.push({ name: `Player ${this.players.length+1}`, color: COLORS[this.players.length % 8], scores: {} }); this.renderAll(); }
            removePlayer(i) { if(this.players.length > 1) { this.players.splice(i,1); this.renderAll(); }}
            toggleMode() { this.isScorecardOnly = !this.isScorecardOnly; document.getElementById('modeBtn').innerText = this.isScorecardOnly ? "üéÆ Enable Dice" : "üìù Scorecard Only"; this.renderRows(); }
            toggleTheme() { document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark'; }
        }

        const game = new YahtzeeElite();
    </script>
</body>
</html>